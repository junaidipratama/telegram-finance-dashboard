<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ’° Finance Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <style>
        /* ===== VARIABLES ===== */
        :root {
            --primary-dark: #0a192f;
            --primary-blue: #1e3a8a;
            --accent-gold: #d4af37;
            --accent-light: #fbbf24;
            --text-light: #f8fafc;
            --text-gray: #94a3b8;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border-radius: 12px;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--primary-dark);
            color: var(--text-light);
            line-height: 1.6;
            padding: 16px;
            max-width: 100%;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ===== HEADER ===== */
        .app-header {
            background: linear-gradient(135deg, var(--primary-blue), #1e40af);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(212, 175, 55, 0.2);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--accent-gold) 0%, transparent 70%);
            opacity: 0.1;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .app-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(to right, var(--text-light), var(--accent-light));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-subtitle {
            color: var(--text-gray);
            font-size: 0.95rem;
        }

        /* ===== MARKET TICKER ===== */
        .market-ticker {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .ticker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            min-width: 200px;
        }

        .ticker-icon {
            color: var(--accent-gold);
            font-size: 1.2rem;
        }

        .ticker-label {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .ticker-value {
            font-weight: 600;
            margin-left: auto;
            font-size: 1.1rem;
        }

        /* ===== SUMMARY CARDS ===== */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .summary-card.income::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: var(--success);
        }

        .summary-card.expense::before {
            background: var(--danger);
        }

        .summary-card.balance::before {
            background: var(--accent-gold);
        }

        .summary-card.assets::before {
            background: var(--primary-blue);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 1rem;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            font-size: 1.2rem;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .card-change {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .positive { color: var(--success); }
        .negative { color: var(--danger); }

        /* ===== CHARTS SECTION ===== */
        .section-title {
            font-size: 1.4rem;
            margin: 30px 0 20px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .charts-container {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .chart-tab {
            padding: 10px 24px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-tab.active {
            background: var(--accent-gold);
            color: var(--primary-dark);
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* ===== TRANSACTIONS SECTION ===== */
        .transactions-container {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-group {
            position: relative;
            min-width: 180px;
        }

        .filter-label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .select2-container {
            width: 100% !important;
        }

        .select2-selection {
            background: var(--bg-dark) !important;
            border: 1px solid rgba(212, 175, 55, 0.3) !important;
            border-radius: 8px !important;
            color: var(--text-light) !important;
            min-height: 42px !important;
        }

        .select2-selection__rendered {
            color: var(--text-light) !important;
            padding-left: 12px !important;
        }

        .select2-dropdown {
            background: var(--bg-card) !important;
            border: 1px solid rgba(212, 175, 55, 0.3) !important;
        }

        .select2-search__field {
            background: var(--bg-dark) !important;
            color: var(--text-light) !important;
            border: 1px solid rgba(212, 175, 55, 0.3) !important;
        }

        .select2-results__option {
            color: var(--text-light) !important;
            background: var(--bg-card) !important;
        }

        .select2-results__option--highlighted {
            background: var(--primary-blue) !important;
        }

        /* ===== TABLE STYLING ===== */
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .transactions-table th {
            background: rgba(30, 58, 138, 0.3);
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--accent-light);
            border-bottom: 2px solid var(--accent-gold);
        }

        .transactions-table td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .transactions-table tr:hover {
            background: rgba(30, 58, 138, 0.1);
        }

        .transaction-income {
            color: var(--success);
            font-weight: 600;
        }

        .transaction-expense {
            color: var(--danger);
            font-weight: 600;
        }

        .transaction-category {
            background: rgba(30, 58, 138, 0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
        }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-light));
            color: var(--primary-dark);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: var(--primary-blue);
            color: var(--text-light);
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* ===== PAGINATION ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 24px;
        }

        .page-info {
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 32px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
            border: 1px solid var(--accent-gold);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--text-light);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            background: var(--bg-dark);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-gold);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(30, 41, 59, 0.5) 25%, rgba(30, 41, 59, 0.8) 50%, rgba(30, 41, 59, 0.5) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .transactions-table {
                display: block;
                overflow-x: auto;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        /* ===== DARK SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-gold);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">
                    <i class="fas fa-chart-line"></i>
                    Dashboard Keuangan Pribadi
                </h1>
                <p class="app-subtitle">Update real-time dari Google Sheets â€¢ Tema: Biru Tua & Emas</p>
                
                <div class="market-ticker">
                    <div class="ticker-item" id="gold-ticker">
                        <i class="fas fa-coins ticker-icon"></i>
                        <span class="ticker-label">Harga Emas</span>
                        <span class="ticker-value" id="gold-price">Loading...</span>
                    </div>
                    <div class="ticker-item" id="btc-ticker">
                        <i class="fab fa-bitcoin ticker-icon"></i>
                        <span class="ticker-label">Bitcoin</span>
                        <span class="ticker-value" id="btc-price">Loading...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- SUMMARY CARDS -->
        <div class="summary-grid">
            <div class="summary-card income">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-money-bill-wave card-icon"></i>
                        Pemasukan Bulan Ini
                    </h3>
                    <span class="card-change positive">+12%</span>
                </div>
                <div class="card-value" id="income-value">Rp 0</div>
                <div class="card-desc">Dari semua sumber</div>
            </div>

            <div class="summary-card expense">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-shopping-cart card-icon"></i>
                        Pengeluaran Bulan Ini
                    </h3>
                    <span class="card-change negative">-5%</span>
                </div>
                <div class="card-value" id="expense-value">Rp 0</div>
                <div class="card-desc">Termasuk kebutuhan & hiburan</div>
            </div>

            <div class="summary-card balance">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-wallet card-icon"></i>
                        Saldo Tersedia
                    </h3>
                    <span class="card-change positive">+8%</span>
                </div>
                <div class="card-value" id="balance-value">Rp 0</div>
                <div class="card-desc">Setelah pemasukan & pengeluaran</div>
            </div>

            <div class="summary-card assets">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-landmark card-icon"></i>
                        Total Aset
                    </h3>
                    <span class="card-change positive">+15%</span>
                </div>
                <div class="card-value" id="assets-value">Rp 0</div>
                <div class="card-desc">Termasuk investasi & tabungan</div>
            </div>
        </div>

        <!-- CHARTS SECTION -->
        <h2 class="section-title">
            <i class="fas fa-chart-pie"></i>
            Grafik Analisis Keuangan
        </h2>
        
        <div class="charts-container">
            <div class="chart-tabs">
                <button class="chart-tab active" data-chart="pie">Pie Chart (Kategori)</button>
                <button class="chart-tab" data-chart="bar">Bar Chart (Bulanan)</button>
                <button class="chart-tab" data-chart="line">Line Chart (Trend)</button>
            </div>
            
            <div class="chart-wrapper">
                <canvas id="financeChart"></canvas>
            </div>
        </div>

        <!-- TRANSACTIONS SECTION -->
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-list-alt"></i>
                Transaksi Terbaru
            </h2>
            
            <div class="filters">
                <div class="filter-group">
                    <label class="filter-label">Periode</label>
                    <select id="period-filter" class="filter-select" multiple>
                        <option value="this_month" selected>Bulan Ini</option>
                        <option value="last_month">Bulan Lalu</option>
                        <option value="custom">Kustom</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Kategori</label>
                    <select id="category-filter" class="filter-select" multiple>
                        <option value="all">Semua Kategori</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" id="add-transaction-btn">
                    <i class="fas fa-plus"></i>
                    Tambah Transaksi
                </button>
            </div>
        </div>

        <div class="transactions-container">
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th width="120">Tanggal</th>
                        <th width="150">Kategori</th>
                        <th width="120">Nilai</th>
                        <th>Keterangan</th>
                        <th width="150">Aksi</th>
                    </tr>
                </thead>
                <tbody id="transactions-body">
                    <!-- Data akan diisi oleh JavaScript -->
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <div class="loading" style="margin: 0 auto;"></div>
                            <p style="margin-top: 10px; color: var(--text-gray);">Memuat transaksi...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div class="pagination">
                <button class="btn btn-secondary" id="prev-page" disabled>
                    <i class="fas fa-chevron-left"></i> Sebelumnya
                </button>
                <span class="page-info" id="page-info">Halaman 1 dari 1</span>
                <button class="btn btn-secondary" id="next-page" disabled>
                    Selanjutnya <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL TAMBAH/EDIT TRANSAKSI -->
    <div class="modal" id="transaction-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Tambah Transaksi Baru</h3>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            
            <form id="transaction-form">
                <input type="hidden" id="edit-row-id">
                
                <div class="form-group">
                    <label class="form-label">Tanggal *</label>
                    <input type="date" class="form-input" id="transaction-date" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Kategori (Opsional)</label>
                    <input type="text" class="form-input" id="transaction-category" 
                           list="category-suggestions" placeholder="Contoh: Makan, Transport">
                    <datalist id="category-suggestions"></datalist>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nilai (Rp) *</label>
                    <input type="number" class="form-input" id="transaction-value" 
                           required step="1000" placeholder="Contoh: 50000">
                    <small style="color: var(--text-gray); margin-top: 5px; display: block;">
                        Gunakan minus (-) untuk pengeluaran: -50000
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Keterangan (Opsional)</label>
                    <input type="text" class="form-input" id="transaction-description" 
                           placeholder="Contoh: Nasi goreng, Bensin motor">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Jumlah (Opsional)</label>
                    <input type="number" class="form-input" id="transaction-quantity" 
                           value="1" min="1" step="1" placeholder="1">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-transaction">Batal</button>
                    <button type="submit" class="btn btn-primary" id="submit-transaction">
                        <span id="submit-text">Simpan Transaksi</span>
                        <span class="loading" id="submit-loading" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL KONFIRMASI HAPUS -->
    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Konfirmasi Penghapusan</h3>
                <button class="close-modal" id="close-confirm">&times;</button>
            </div>
            
            <p style="margin-bottom: 30px; color: var(--text-light);">
                Apakah Anda yakin ingin menghapus transaksi ini?
                <br><br>
                <strong id="confirm-details" style="color: var(--accent-light);"></strong>
            </p>
            
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancel-delete">Batal</button>
                <button class="btn btn-danger" id="confirm-delete">
                    <i class="fas fa-trash"></i> Ya, Hapus
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // ===== KONFIGURASI =====
        const CONFIG = {
            GAS_URL: 'https://script.google.com/macros/s/AKfycbxUzQ_ruSsy9eysRj5octStLx62_x4o5DSTEtKKZOqkIE1dmvHrlYBIYtA6RLbZgew1/exec', // Ganti dengan URL Web App GAS
            ITEMS_PER_PAGE: 10,
            REFRESH_INTERVAL: 30000 // 30 detik
        };

        // ===== STATE MANAGEMENT =====
        let appState = {
            chatId: null,
            userData: null,
            currentPage: 1,
            totalTransactions: 0,
            categories: [],
            currentFilters: {
                period: ['this_month'],
                categories: ['all']
            },
            chart: null,
            editingRow: null
        };

        // ===== TELEGRAM WEB APP INIT =====
        document.addEventListener('DOMContentLoaded', function() {
            // Inisialisasi Telegram Web App
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            // Dapatkan user data dari Telegram
            const user = window.Telegram.WebApp.initDataUnsafe.user;
            if (user) {
                appState.chatId = user.id;
                appState.userData = user;
                console.log('User authorized:', user);
                
                // Load data
                loadDashboardData();
                loadMarketData();
                loadCategories();
                loadTransactions();
                setupCharts();
            } else {
                showError('Gagal mengautentikasi pengguna. Pastikan Anda membuka dari Telegram.');
            }
            
            // Setup event listeners
            setupEventListeners();
            initializeFilters();
        });

        // ===== API SERVICE =====
        async function callGAS(action, data = {}, method = 'GET') {
            const params = new URLSearchParams({
                action: action,
                chatId: appState.chatId,
                ...data
            });
            
            const url = method === 'GET' 
                ? `${CONFIG.GAS_URL}?${params}`
                : CONFIG.GAS_URL;
            
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                };
                
                if (method === 'POST') {
                    options.body = params;
                }
                
                const response = await fetch(url, options);
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                showError(`Gagal memuat data: ${error.message}`);
                throw error;
            }
        }

        // ===== DASHBOARD FUNCTIONS =====
        async function loadDashboardData() {
            try {
                const data = await callGAS('get_dashboard_summary');
                
                // Format dan update UI
                document.getElementById('income-value').textContent = 
                    formatCurrency(data.pemasukan);
                document.getElementById('expense-value').textContent = 
                    formatCurrency(data.pengeluaran);
                document.getElementById('balance-value').textContent = 
                    formatCurrency(data.saldo);
                document.getElementById('assets-value').textContent = 
                    formatCurrency(data.totalAset);
                
                // Update timestamp
                const updated = new Date(data.updatedAt).toLocaleTimeString('id-ID');
                console.log('Dashboard updated at:', updated);
            } catch (error) {
                // Fallback values
                showError('Gagal memuat ringkasan dashboard');
            }
        }

        async function loadMarketData() {
            try {
                const data = await callGAS('get_market_data');
                
                // Update UI
                document.getElementById('gold-price').textContent = 
                    formatCurrency(data.emas) + '/gr';
                document.getElementById('btc-price').textContent = 
                    formatCurrency(data.bitcoin);
                
                // Update timestamp
                const updated = new Date(data.updatedAt).toLocaleTimeString('id-ID');
                console.log('Market data updated at:', updated);
            } catch (error) {
                // Fallback to spreadsheet values
                showError('Gagal memuat data market');
            }
        }

        async function loadCategories() {
            try {
                const data = await callGAS('get_categories');
                appState.categories = data.categories;
                
                // Update kategori filter
                const categoryFilter = $('#category-filter');
                categoryFilter.empty();
                categoryFilter.append('<option value="all">Semua Kategori</option>');
                
                data.categories.forEach(category => {
                    categoryFilter.append(`<option value="${category}">${category}</option>`);
                });
                
                // Update kategori suggestions di modal
                const datalist = document.getElementById('category-suggestions');
                datalist.innerHTML = '';
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        async function loadTransactions(page = 1) {
            const offset = (page - 1) * CONFIG.ITEMS_PER_PAGE;
            
            try {
                showLoading(true);
                
                const data = await callGAS('get_recent_transactions', {
                    limit: CONFIG.ITEMS_PER_PAGE,
                    offset: offset
                });
                
                appState.totalTransactions = data.total;
                appState.currentPage = page;
                
                updateTransactionsTable(data.transactions);
                updatePagination();
            } catch (error) {
                showError('Gagal memuat transaksi');
            } finally {
                showLoading(false);
            }
        }

        async function applyFilters() {
            try {
                showLoading(true);
                
                const filters = {
                    period: appState.currentFilters.period[0],
                    categories: appState.currentFilters.categories
                };
                
                // Jika "all" dipilih, kirim array kosong
                if (filters.categories.includes('all')) {
                    filters.categories = [];
                }
                
                const data = await callGAS('get_filtered_data', {
                    filters: JSON.stringify(filters)
                });
                
                updateTransactionsTable(data.transactions);
                updateCharts(data.transactions);
            } catch (error) {
                showError('Gagal menerapkan filter');
            } finally {
                showLoading(false);
            }
        }

        // ===== UI UPDATES =====
        function updateTransactionsTable(transactions) {
            const tbody = document.getElementById('transactions-body');
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 2rem; color: var(--text-gray);"></i>
                            <p style="margin-top: 10px; color: var(--text-gray);">Tidak ada transaksi</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            transactions.forEach(transaction => {
                const isIncome = transaction.tipe === 'pemasukan';
                const valueClass = isIncome ? 'transaction-income' : 'transaction-expense';
                const valuePrefix = isIncome ? '+' : '-';
                
                html += `
                    <tr>
                        <td>${transaction.tanggal}</td>
                        <td>
                            <span class="transaction-category">
                                ${transaction.kategori}
                            </span>
                        </td>
                        <td class="${valueClass}">
                            ${valuePrefix}${formatCurrency(Math.abs(transaction.nilai))}
                        </td>
                        <td>${transaction.keterangan || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm edit-btn" 
                                        data-row="${transaction.rowId}"
                                        data-category="${transaction.kategori}"
                                        data-value="${transaction.nilai}"
                                        data-description="${transaction.keterangan}"
                                        data-quantity="${transaction.jumlah}"
                                        data-date="${transaction.tanggal}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-btn" 
                                        data-row="${transaction.rowId}"
                                        data-details="${transaction.kategori} - ${formatCurrency(transaction.nilai)}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // Attach event listeners to buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', handleEditClick);
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteClick);
            });
        }

        function updatePagination() {
            const totalPages = Math.ceil(appState.totalTransactions / CONFIG.ITEMS_PER_PAGE);
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            
            pageInfo.textContent = `Halaman ${appState.currentPage} dari ${totalPages}`;
            prevBtn.disabled = appState.currentPage <= 1;
            nextBtn.disabled = appState.currentPage >= totalPages;
        }

        function updateCharts(transactions) {
            // Data untuk chart
            const categoryData = {};
            const monthlyData = {};
            
            transactions.forEach(t => {
                // Hitung per kategori
                const category = t.kategori || 'Lainnya';
                categoryData[category] = (categoryData[category] || 0) + Math.abs(t.nilai);
                
                // Hitung per bulan
                const date = new Date(t.tanggal.split('/').reverse().join('-'));
                const monthYear = `${date.getMonth()+1}/${date.getFullYear()}`;
                monthlyData[monthYear] = (monthlyData[monthYear] || 0) + t.nilai;
            });
            
            // Update chart berdasarkan tab aktif
            const activeTab = document.querySelector('.chart-tab.active').dataset.chart;
            renderChart(activeTab, { categoryData, monthlyData });
        }

        function renderChart(type, data) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            
            // Hancurkan chart sebelumnya
            if (appState.chart) {
                appState.chart.destroy();
            }
            
            let chartConfig;
            
            switch(type) {
                case 'pie':
                    chartConfig = {
                        type: 'pie',
                        data: {
                            labels: Object.keys(data.categoryData),
                            datasets: [{
                                data: Object.values(data.categoryData),
                                backgroundColor: [
                                    '#d4af37', '#1e3a8a', '#10b981', '#ef4444', '#f59e0b',
                                    '#8b5cf6', '#06b6d4', '#ec4899'
                                ],
                                borderWidth: 2,
                                borderColor: '#0f172a'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        color: '#f8fafc',
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Distribusi Pengeluaran per Kategori',
                                    color: '#f8fafc',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    };
                    break;
                    
                case 'bar':
                    const months = Object.keys(data.monthlyData);
                    const values = Object.values(data.monthlyData);
                    
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: [{
                                label: 'Saldo Bulanan',
                                data: values,
                                backgroundColor: values.map(v => 
                                    v >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'
                                ),
                                borderColor: values.map(v => 
                                    v >= 0 ? '#10b981' : '#ef4444'
                                ),
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#f8fafc'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Pemasukan vs Pengeluaran Bulanan',
                                    color: '#f8fafc',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#94a3b8',
                                        callback: function(value) {
                                            return 'Rp ' + value.toLocaleString('id-ID');
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(148, 163, 184, 0.1)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#94a3b8'
                                    },
                                    grid: {
                                        color: 'rgba(148, 163, 184, 0.1)'
                                    }
                                }
                            }
                        }
                    };
                    break;
                    
                case 'line':
                    chartConfig = {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
                            datasets: [{
                                label: 'Trend Saldo',
                                data: [1000000, 1500000, 1200000, 1800000, 2000000, 2200000, 2500000, 2300000, 2700000, 3000000, 3200000, 3500000],
                                borderColor: '#d4af37',
                                backgroundColor: 'rgba(212, 175, 55, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Trend Pertumbuhan Saldo Tahunan',
                                    color: '#f8fafc',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    ticks: {
                                        color: '#94a3b8',
                                        callback: function(value) {
                                            return 'Rp ' + (value / 1000000).toFixed(1) + 'Jt';
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(148, 163, 184, 0.1)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#94a3b8'
                                    },
                                    grid: {
                                        color: 'rgba(148, 163, 184, 0.1)'
                                    }
                                }
                            }
                        }
                    };
                    break;
            }
            
            appState.chart = new Chart(ctx, chartConfig);
        }

        // ===== FORM HANDLING =====
        async function handleTransactionSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-transaction');
            const submitText = document.getElementById('submit-text');
            const submitLoading = document.getElementById('submit-loading');
            
            // Show loading
            submitText.style.display = 'none';
            submitLoading.style.display = 'inline-block';
            submitBtn.disabled = true;
            
            try {
                const formData = {
                    kategori: document.getElementById('transaction-category').value,
                    nilai: parseFloat(document.getElementById('transaction-value').value),
                    keterangan: document.getElementById('transaction-description').value,
                    jumlah: parseInt(document.getElementById('transaction-quantity').value) || 1,
                    tanggal: document.getElementById('transaction-date').value
                };
                
                const rowId = document.getElementById('edit-row-id').value;
                const action = rowId ? 'edit_transaction' : 'add_transaction';
                
                if (rowId) {
                    formData.rowId = parseInt(rowId);
                }
                
                const result = await callGAS(action, formData, 'POST');
                
                if (result.success) {
                    showSuccess(rowId ? 'Transaksi berhasil diperbarui!' : 'Transaksi berhasil ditambahkan!');
                    closeModal();
                    
                    // Refresh data
                    loadDashboardData();
                    loadTransactions(appState.currentPage);
                    
                    // Clear form
                    document.getElementById('transaction-form').reset();
                    document.getElementById('edit-row-id').value = '';
                }
            } catch (error) {
                showError('Gagal menyimpan transaksi: ' + error.message);
            } finally {
                // Hide loading
                submitText.style.display = 'inline';
                submitLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        async function handleDeleteTransaction(rowId) {
            try {
                const result = await callGAS('delete_transaction', { rowId: parseInt(rowId) }, 'POST');
                
                if (result.success) {
                    showSuccess('Transaksi berhasil dihapus!');
                    closeModal('confirm-modal');
                    
                    // Refresh data
                    loadDashboardData();
                    loadTransactions(appState.currentPage);
                }
            } catch (error) {
                showError('Gagal menghapus transaksi: ' + error.message);
            }
        }

        // ===== EVENT HANDLERS =====
        function handleEditClick(e) {
            const btn = e.currentTarget;
            appState.editingRow = btn.dataset.row;
            
            // Isi form modal
            document.getElementById('modal-title').textContent = 'Edit Transaksi';
            document.getElementById('edit-row-id').value = btn.dataset.row;
            document.getElementById('transaction-category').value = btn.dataset.category;
            document.getElementById('transaction-value').value = btn.dataset.value;
            document.getElementById('transaction-description').value = btn.dataset.description;
            document.getElementById('transaction-quantity').value = btn.dataset.quantity;
            
            // Format tanggal untuk input date (YYYY-MM-DD)
            const dateParts = btn.dataset.date.split('/');
            if (dateParts.length === 3) {
                const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                document.getElementById('transaction-date').value = formattedDate;
            }
            
            // Tampilkan modal
            openModal('transaction-modal');
        }

        function handleDeleteClick(e) {
            const btn = e.currentTarget;
            const details = btn.dataset.details;
            
            document.getElementById('confirm-details').textContent = details;
            document.getElementById('confirm-delete').dataset.rowId = btn.dataset.row;
            
            openModal('confirm-modal');
        }

        function setupEventListeners() {
            // Pagination
            document.getElementById('prev-page').addEventListener('click', () => {
                if (appState.currentPage > 1) {
                    loadTransactions(appState.currentPage - 1);
                }
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                const totalPages = Math.ceil(appState.totalTransactions / CONFIG.ITEMS_PER_PAGE);
                if (appState.currentPage < totalPages) {
                    loadTransactions(appState.currentPage + 1);
                }
            });
            
            // Tambah transaksi button
            document.getElementById('add-transaction-btn').addEventListener('click', () => {
                document.getElementById('modal-title').textContent = 'Tambah Transaksi Baru';
                document.getElementById('edit-row-id').value = '';
                document.getElementById('transaction-form').reset();
                document.getElementById('transaction-date').valueAsDate = new Date();
                openModal('transaction-modal');
            });
            
            // Form submission
            document.getElementById('transaction-form').addEventListener('submit', handleTransactionSubmit);
            
            // Modal close buttons
            document.getElementById('close-modal').addEventListener('click', () => closeModal('transaction-modal'));
            document.getElementById('cancel-transaction').addEventListener('click', () => closeModal('transaction-modal'));
            document.getElementById('close-confirm').addEventListener('click', () => closeModal('confirm-modal'));
            document.getElementById('cancel-delete').addEventListener('click', () => closeModal('confirm-modal'));
            
            // Confirm delete
            document.getElementById('confirm-delete').addEventListener('click', () => {
                const rowId = document.getElementById('confirm-delete').dataset.rowId;
                handleDeleteTransaction(rowId);
            });
            
            // Chart tabs
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Update active tab
                    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update chart
                    updateCharts([]); // Akan diisi setelah data dimuat
                });
            });
            
            // Close modal on background click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
            
            // Auto-refresh data setiap 30 detik
            setInterval(() => {
                loadDashboardData();
                loadMarketData();
            }, CONFIG.REFRESH_INTERVAL);
        }

        function initializeFilters() {
            // Initialize Select2
            $('#period-filter').select2({
                placeholder: 'Pilih periode',
                allowClear: false,
                multiple: true,
                width: '100%',
                theme: 'dark'
            });
            
            $('#category-filter').select2({
                placeholder: 'Pilih kategori',
                allowClear: false,
                multiple: true,
                width: '100%',
                theme: 'dark'
            });
            
            // Filter change events
            $('#period-filter').on('change', function() {
                appState.currentFilters.period = $(this).val();
                applyFilters();
            });
            
            $('#category-filter').on('change', function() {
                appState.currentFilters.categories = $(this).val();
                applyFilters();
            });
        }

        function setupCharts() {
            // Initial chart setup
            const initialData = {
                categoryData: {},
                monthlyData: {}
            };
            renderChart('pie', initialData);
        }

        // ===== UI UTILITIES =====
        function formatCurrency(value) {
            if (isNaN(value)) return 'Rp 0';
            
            const num = Math.abs(parseFloat(value));
            if (num >= 1000000000) {
                return 'Rp ' + (num / 1000000000).toFixed(1) + 'M';
            } else if (num >= 1000000) {
                return 'Rp ' + (num / 1000000).toFixed(1) + 'Jt';
            } else {
                return 'Rp ' + num.toLocaleString('id-ID');
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            if (modalId) {
                document.getElementById(modalId).classList.remove('active');
            } else {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
            document.body.style.overflow = 'auto';
        }

        function showLoading(show) {
            if (show) {
                document.body.style.opacity = '0.7';
                document.body.style.pointerEvents = 'none';
            } else {
                document.body.style.opacity = '1';
                document.body.style.pointerEvents = 'auto';
            }
        }

        function showError(message) {
            // Simple error notification
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ef4444;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            errorDiv.innerHTML = `
                <strong><i class="fas fa-exclamation-circle"></i> Error</strong>
                <p style="margin: 5px 0 0; font-size: 0.9em;">${message}</p>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => errorDiv.remove(), 300);
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            successDiv.innerHTML = `
                <strong><i class="fas fa-check-circle"></i> Sukses</strong>
                <p style="margin: 5px 0 0; font-size: 0.9em;">${message}</p>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => successDiv.remove(), 300);
            }, 3000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
